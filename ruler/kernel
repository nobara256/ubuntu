#!/bin/bash

set -eE
trap 'echo Error: in $0 on line $LINENO' ERR

# export ARCH=arm64
# export DEBFULLNAME="Nobara Kurokawa"
# export DEBEMAIL="nobara@kurokawa"

# export KERNEL_MAJOR_RELEASE="6.13.0"
# export KERNEL_DEBIAN_RELEASE="5120"

export KERNEL_REBUILD=1

export KERNEL_FLAVOUR="rockchip"
export KERNEL_PACKAGE="${KERNEL_MAJOR_RELEASE}-${KERNEL_FLAVOUR}"
export KERNEL_RELEASE="${KERNEL_MAJOR_RELEASE}-${KERNEL_DEBIAN_RELEASE}.${KERNEL_REBUILD}"

export PACKAGE_PATH=$1
export AARCH64="$PACKAGE_PATH/__AARCH64__"

# export ARCH_HOST_CC="aarch64-linux-gnu-gcc"
export ARCH_HOST_CC="x86_64-linux-gnu-gcc"


export MAKE="make \
             ARCH=$ARCH \
             CROSS_COMPILE=aarch64-linux-gnu- \
             CC=aarch64-linux-gnu-gcc \
             HOSTCC=$ARCH_HOST_CC \
             CONFIG_DEBUG_SECTION_MISMATCH=y \
             KERNELVERSION=$KERNEL_RELEASE-$KERNEL_FLAVOUR \
             KBUILD_BUILD_VERSION=$KERNEL_DEBIAN_RELEASE \
             LOCALVERSION= \
             localver-extra= \
             CFLAGS_MODULE="-DPKG_ABI=$KERNEL_DEBIAN_RELEASE" \
             PYTHON=python3 \
             O=$AARCH64"


set -x


# Apply .config
$MAKE olddefconfig

# Make kernel modules dtb
$MAKE -j$(nproc) Image modules dtbs




#### Kernel Image Package ####
export KERNEL_IMAGE_PACKAGE="$PACKAGE_PATH/kernel-image-${KERNEL_PACKAGE}_${KERNEL_RELEASE}_${ARCH}"

# Install dtb
$MAKE dtbs_install INSTALL_DTBS_PATH=$KERNEL_MODULES_PACKAGE/lib/firmware/$KERNEL_RELEASE-$KERNEL_FLAVOUR/device-tree

# Copy the kernel Image
mkdir -p $KERNEL_IMAGE_PACKAGE/boot
cp $AARCH64/arch/arm64/boot/Image $KERNEL_IMAGE_PACKAGE/boot/vmlinuz-$KERNEL_RELEASE-$KERNEL_FLAVOUR
cp $AARCH64/System.map $KERNEL_IMAGE_PACKAGE/boot/System.map-$KERNEL_RELEASE-$KERNEL_FLAVOUR
cp $AARCH64/.config $KERNEL_IMAGE_PACKAGE/boot/config-$KERNEL_RELEASE-$KERNEL_FLAVOUR

# DEBIAN control
mkdir -p $KERNEL_IMAGE_PACKAGE/DEBIAN

cat > $KERNEL_IMAGE_PACKAGE/DEBIAN/control << HEREDOC
Package: kernel-image-$KERNEL_PACKAGE
Source: kernel-image-$KERNEL_PACKAGE
Version: $KERNEL_RELEASE
Section: main
Priority: standard
Architecture: $ARCH
Depends: kmod, linux-base (>= 4.5ubuntu1~16.04.1)
Homepage: https://kernel.org/
Rules-Requires-Root: no
Maintainer: $DEBFULLNAME <$DEBEMAIL>
Description: A minimal kernel package for ubuntu-server aarch64 running on opi-5-plus.
HEREDOC

# A simple postinstall script
cat > $KERNEL_IMAGE_PACKAGE/DEBIAN/postinst << HEREDOC
DEB_MAINT_PARAMS="$*" run-parts --report --exit-on-error --arg=$KERNEL_RELEASE-$KERNEL_FLAVOUR --arg=/boot/vmlinuz-$KERNEL_RELEASE-$KERNEL_FLAVOUR /etc/kernel/postinst.d
HEREDOC

# Assign proper permission for the script
chmod 775 $KERNEL_IMAGE_PACKAGE/DEBIAN/postinst

# Build packaage
dpkg-deb --build $KERNEL_IMAGE_PACKAGE $PACKAGE_PATH




#### Kernel Modules Package ####
export KERNEL_MODULES_PACKAGE="$PACKAGE_PATH/kernel-modules-${KERNEL_PACKAGE}_${KERNEL_RELEASE}_${ARCH}"

# Install modules vdso
$MAKE modules_install vdso_install INSTALL_MOD_STRIP=1 INSTALL_MOD_PATH=$KERNEL_MODULES_PACKAGE INSTALL_FW_PATH=$KERNEL_MODULES_PACKAGE/lib/firmware/$KERNEL_RELEASE-$KERNEL_FLAVOUR

# Apply module blacklist
mkdir -p $KERNEL_MODULES_PACKAGE/lib/modprobe.d
cat > $KERNEL_MODULES_PACKAGE/lib/modprobe.d/blacklist_${KERNEL_RELEASE}-${KERNEL_FLAVOUR}.conf << HEREDOC
# Kernel supplied blacklist for opi-5-plus ${KERNEL_RELEASE}-${KERNEL_FLAVOUR} arm64
# Autogenerated watchdog blacklist
blacklist gpio_wdt
blacklist pcwd_pci
blacklist pcwd_usb
blacklist softdog
blacklist wdat_wdt
blacklist wdt_pci
HEREDOC

# Dummy kernel header directory
mkdir -p $KERNEL_MODULES_PACKAGE/usr/src/linux-headers-$KERNEL_RELEASE-$KERNEL_FLAVOUR
ln -f -n -s /usr/src/linux-headers-$KERNEL_RELEASE-$KERNEL_FLAVOUR $KERNEL_MODULES_PACKAGE/lib/modules/$KERNEL_RELEASE-$KERNEL_FLAVOUR/build

# Everything in a single package
mkdir -p $KERNEL_MODULES_PACKAGE/DEBIAN

cat > $KERNEL_MODULES_PACKAGE/DEBIAN/control << HEREDOC
Package: kernel-modules-$KERNEL_PACKAGE
Source: kernel-modules-$KERNEL_PACKAGE
Version: $KERNEL_RELEASE
Section: main
Priority: standard
Architecture: $ARCH
Depends: kmod, linux-base (>= 4.5ubuntu1~16.04.1)
Homepage: https://kernel.org/
Rules-Requires-Root: no
Maintainer: $DEBFULLNAME <$DEBEMAIL>
Description: A minimal kernel package for ubuntu-server aarch64 running on opi-5-plus.
HEREDOC

# Build packaage
dpkg-deb --build $KERNEL_MODULES_PACKAGE $PACKAGE_PATH



# A dummy package
export KERNEL_DUMMY_PACKAGE="$PACKAGE_PATH/kernel-${KERNEL_FLAVOUR}_${KERNEL_RELEASE}_${ARCH}"

mkdir -p $KERNEL_DUMMY_PACKAGE/DEBIAN

cat > $KERNEL_DUMMY_PACKAGE/DEBIAN/control << HEREDOC
Package: kernel-$KERNEL_FLAVOUR
Source: kernel-$KERNEL_FLAVOUR
Version: $KERNEL_RELEASE
Section: main
Priority: standard
Architecture: $ARCH
Depends: kernel-image-${KERNEL_PACKAGE}, kernel-modules-${KERNEL_PACKAGE}
Homepage: https://kernel.org/
Rules-Requires-Root: no
Maintainer: $DEBFULLNAME <$DEBEMAIL>
Description: A minimal kernel package for ubuntu-server aarch64 running on opi-5-plus.
HEREDOC

# Build the dummy packaage
dpkg-deb --build $KERNEL_DUMMY_PACKAGE $PACKAGE_PATH




set +x

echo "Bye Bye!!"

trap '' EXIT
exit 0
